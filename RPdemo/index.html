<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIDC å®¢æˆ·ç«¯æµ‹è¯•å·¥å…·</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        h1 { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .status { padding: 15px; border-radius: 5px; margin-top: 20px; }
        .status.logged-in { background-color: #e6f7ff; border-left: 5px solid #1890ff; }
        .status.logged-out { background-color: #fffbe6; border-left: 5px solid #faad14; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button.logout { background-color: #dc3545; }
        button.logout:hover { background-color: #c82333; }
        pre { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .config-section { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .config-section h2 { margin-top: 0; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>OIDC å®¢æˆ·ç«¯æµ‹è¯•å·¥å…·</h1>

        <!-- IDP é…ç½®åŒºåŸŸ -->
        <div class="config-section">
            <h2>1. IDP é…ç½® (è¯·æ ¹æ®ä½ çš„ IDP ä¿®æ”¹)</h2>
            <p>è¯·ç¡®ä¿ <code>redirect_uri</code> ä¸ä½ åœ¨ IDP ä¸­æ³¨å†Œçš„åœ°å€å®Œå…¨ä¸€è‡´ã€‚ä¾‹å¦‚ï¼šhttp://localhost:8080</p>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="status-container">
            <!-- åŠ¨æ€å†…å®¹å°†æ’å…¥è¿™é‡Œ -->
        </div>
    </div>

    <script>
        // =================================================================
        // 1. IDP é…ç½® (åœ¨è¿™é‡Œä¿®æ”¹ä½ çš„ IDP ä¿¡æ¯)
        // =================================================================
        const idpConfig = {
            // --- å¿…å¡« ---
            client_id: 'your-client-id', // ä½ çš„å®¢æˆ·ç«¯ID
            redirect_uri: 'http://localhost:8080', // å›è°ƒåœ°å€ï¼Œå¿…é¡»ä¸IDPæ³¨å†Œçš„ä¸€è‡´
            scope: 'openid profile email', // ç”³è¯·çš„æƒé™èŒƒå›´

            // --- ä» IDP çš„ .well-known/openid-configuration è·å– ---
            authorization_endpoint: 'https://your-idp.com/auth', // æˆæƒç«¯ç‚¹
            token_endpoint: 'https://your-idp.com/token', // ä»¤ç‰Œç«¯ç‚¹
            userinfo_endpoint: 'https://your-idp.com/userinfo', // ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹ (å¯é€‰)
            end_session_endpoint: 'https://your-idp.com/logout' // ç™»å‡ºç«¯ç‚¹ (å¯é€‰)
        };
        // =================================================================


        // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // å·¥å…·å‡½æ•°ï¼šè§£æ URL æŸ¥è¯¢å‚æ•°
        function parseQueryString(queryString) {
            const params = {};
            const pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }

        // å·¥å…·å‡½æ•°ï¼šBase64URL è§£ç 
        function base64UrlDecode(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) {
                str += '=';
            }
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // è§£æ ID Token (JWT)
        function parseIdToken(idToken) {
            const parts = idToken.split('.');
            if (parts.length !== 3) {
                throw new Error('ID Token æ ¼å¼é”™è¯¯');
            }
            const payload = parts[1];
            return JSON.parse(base64UrlDecode(payload));
        }

        // æ¸²æŸ“é¡µé¢çŠ¶æ€
        function renderStatus() {
            const container = document.getElementById('status-container');
            const idToken = localStorage.getItem('id_token');
            const userInfo = localStorage.getItem('user_info');

            if (idToken) {
                // å·²ç™»å½•çŠ¶æ€
                container.innerHTML = `
                    <div class="status logged-in">
                        <h2>âœ… ç™»å½•æˆåŠŸ</h2>
                        <p>ç”¨æˆ·å·²é€šè¿‡ OIDC è®¤è¯ã€‚</p>
                        <button class="logout" onclick="logout()">ç™»å‡º</button>
                    </div>
                    <h2>ID Token å†…å®¹ (Payload)</h2>
                    <pre>${JSON.stringify(parseIdToken(idToken), null, 2)}</pre>
                    ${userInfo ? `
                        <h2>ä» Userinfo Endpoint è·å–çš„ç”¨æˆ·ä¿¡æ¯</h2>
                        <pre>${JSON.stringify(JSON.parse(userInfo), null, 2)}</pre>
                    ` : ''}
                `;
            } else {
                // æœªç™»å½•çŠ¶æ€
                container.innerHTML = `
                    <div class="status logged-out">
                        <h2>ğŸ”’ æœªç™»å½•</h2>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ OIDC ç™»å½•æµç¨‹ã€‚</p>
                        <button onclick="login()">ç™»å½•</button>
                    </div>
                `;
            }
        }

        // ç™»å½•å‡½æ•°
        function login() {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§çŠ¶æ€
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('code_verifier'); // PKCE
            
            // ç”Ÿæˆ state å’Œ code_verifier (ç”¨äºå®‰å…¨)
            const state = generateRandomString(40);
            const codeVerifier = generateRandomString(128);
            
            // å­˜å‚¨åˆ° localStorageï¼Œä»¥ä¾¿åœ¨å›è°ƒæ—¶éªŒè¯
            localStorage.setItem('state', state);
            localStorage.setItem('code_verifier', codeVerifier);

            // æ„å»º OIDC æˆæƒ URL
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: idpConfig.client_id,
                redirect_uri: idpConfig.redirect_uri,
                scope: idpConfig.scope,
                state: state,
                // code_challenge: CODE_CHALLENGE, // å¦‚æœ IDP æ”¯æŒ PKCEï¼Œéœ€è¦è®¡ç®— code_challenge
                // code_challenge_method: 'S256'
            });

            const authUrl = `${idpConfig.authorization_endpoint}?${params.toString()}`;
            console.log('Redirecting to:', authUrl);
            window.location.href = authUrl;
        }

        // å¤„ç† IDP å›è°ƒ
        async function handleCallback() {
            const params = parseQueryString(window.location.search);
            const code = params.code;
            const state = params.state;
            const storedState = localStorage.getItem('state');
            const error = params.error;

            if (error) {
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>âŒ ç™»å½•å¤±è´¥</h2><p>é”™è¯¯: ${error}</p><p>æè¿°: ${params.error_description}</p></div>`;
                return;
            }

            if (!code || !state) {
                // å¦‚æœæ²¡æœ‰ code å’Œ stateï¼Œè¯´æ˜æ˜¯é¦–æ¬¡è®¿é—®ï¼Œä¸æ˜¯å›è°ƒ
                renderStatus();
                return;
            }

            if (state !== storedState) {
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>âŒ å®‰å…¨é”™è¯¯</h2><p>State ä¸åŒ¹é…ï¼Œå¯èƒ½å­˜åœ¨ CSRF æ”»å‡»ã€‚</p></div>`;
                return;
            }

            // ç”¨æˆæƒç æ¢å–ä»¤ç‰Œ
            try {
                const tokenResponse = await fetch(idpConfig.token_endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: idpConfig.redirect_uri,
                        client_id: idpConfig.client_id,
                        // client_secret: 'your-client-secret', // å¦‚æœæ˜¯ confidential client
                        // code_verifier: localStorage.getItem('code_verifier') // PKCE
                    })
                });

                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    throw new Error(`Token request failed: ${tokenResponse.status} ${errorText}`);
                }

                const tokens = await tokenResponse.json();
                
                // å­˜å‚¨ä»¤ç‰Œ
                localStorage.setItem('id_token', tokens.id_token);
                localStorage.setItem('access_token', tokens.access_token);
                if (tokens.refresh_token) {
                    localStorage.setItem('refresh_token', tokens.refresh_token);
                }

                // (å¯é€‰) ä½¿ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯
                if (idpConfig.userinfo_endpoint && tokens.access_token) {
                    try {
                        const userResponse = await fetch(idpConfig.userinfo_endpoint, {
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`
                            }
                        });
                        if (userResponse.ok) {
                            const userInfo = await userResponse.json();
                            localStorage.setItem('user_info', JSON.stringify(userInfo));
                        }
                    } catch (e) {
                        console.error('Failed to fetch user info:', e);
                    }
                }

                // æ¸…ç† URL ä¸­çš„æŸ¥è¯¢å‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);

                // é‡æ–°æ¸²æŸ“é¡µé¢
                renderStatus();

            } catch (error) {
                console.error('Error exchanging code for token:', error);
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>âŒ ä»¤ç‰Œäº¤æ¢å¤±è´¥</h2><p>${error.message}</p></div>`;
            } finally {
                // æ¸…ç†ä¸´æ—¶å­˜å‚¨çš„ state å’Œ code_verifier
                localStorage.removeItem('state');
                localStorage.removeItem('code_verifier');
            }
        }

        // ç™»å‡ºå‡½æ•°
        function logout() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');

            // å¦‚æœ IDP æä¾›äº†ç™»å‡ºç«¯ç‚¹ï¼Œåˆ™è·³è½¬è¿‡å»
            if (idpConfig.end_session_endpoint) {
                // æœ‰äº› IDP éœ€è¦ä¼ é€’ post_logout_redirect_uri
                const logoutUrl = `${idpConfig.end_session_endpoint}?post_logout_redirect_uri=${encodeURIComponent(idpConfig.redirect_uri)}`;
                window.location.href = logoutUrl;
            } else {
                // å¦åˆ™ï¼Œä»…åˆ·æ–°æœ¬åœ°é¡µé¢çŠ¶æ€
                renderStatus();
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            handleCallback();
        };
    </script>

</body>
</html>
