<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIDC 客户端测试工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        h1 { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .status { padding: 15px; border-radius: 5px; margin-top: 20px; }
        .status.logged-in { background-color: #e6f7ff; border-left: 5px solid #1890ff; }
        .status.logged-out { background-color: #fffbe6; border-left: 5px solid #faad14; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button.logout { background-color: #dc3545; }
        button.logout:hover { background-color: #c82333; }
        pre { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .config-section { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .config-section h2 { margin-top: 0; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>OIDC 客户端测试工具</h1>

        <!-- IDP 配置区域 -->
        <div class="config-section">
            <h2>1. IDP 配置 (请根据你的 IDP 修改)</h2>
            <p>请确保 <code>redirect_uri</code> 与你在 IDP 中注册的地址完全一致。例如：http://localhost:8080</p>
        </div>

        <!-- 状态显示区域 -->
        <div id="status-container">
            <!-- 动态内容将插入这里 -->
        </div>
    </div>

    <script>
        // =================================================================
        // 1. IDP 配置 (在这里修改你的 IDP 信息)
        // =================================================================
        const idpConfig = {
            // --- 必填 ---
            client_id: 'your-client-id', // 你的客户端ID
            redirect_uri: 'http://localhost:8080', // 回调地址，必须与IDP注册的一致
            scope: 'openid profile email', // 申请的权限范围

            // --- 从 IDP 的 .well-known/openid-configuration 获取 ---
            authorization_endpoint: 'https://your-idp.com/auth', // 授权端点
            token_endpoint: 'https://your-idp.com/token', // 令牌端点
            userinfo_endpoint: 'https://your-idp.com/userinfo', // 用户信息端点 (可选)
            end_session_endpoint: 'https://your-idp.com/logout' // 登出端点 (可选)
        };
        // =================================================================


        // 工具函数：生成随机字符串
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // 工具函数：解析 URL 查询参数
        function parseQueryString(queryString) {
            const params = {};
            const pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }

        // 工具函数：Base64URL 解码
        function base64UrlDecode(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) {
                str += '=';
            }
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // 解析 ID Token (JWT)
        function parseIdToken(idToken) {
            const parts = idToken.split('.');
            if (parts.length !== 3) {
                throw new Error('ID Token 格式错误');
            }
            const payload = parts[1];
            return JSON.parse(base64UrlDecode(payload));
        }

        // 渲染页面状态
        function renderStatus() {
            const container = document.getElementById('status-container');
            const idToken = localStorage.getItem('id_token');
            const userInfo = localStorage.getItem('user_info');

            if (idToken) {
                // 已登录状态
                container.innerHTML = `
                    <div class="status logged-in">
                        <h2>✅ 登录成功</h2>
                        <p>用户已通过 OIDC 认证。</p>
                        <button class="logout" onclick="logout()">登出</button>
                    </div>
                    <h2>ID Token 内容 (Payload)</h2>
                    <pre>${JSON.stringify(parseIdToken(idToken), null, 2)}</pre>
                    ${userInfo ? `
                        <h2>从 Userinfo Endpoint 获取的用户信息</h2>
                        <pre>${JSON.stringify(JSON.parse(userInfo), null, 2)}</pre>
                    ` : ''}
                `;
            } else {
                // 未登录状态
                container.innerHTML = `
                    <div class="status logged-out">
                        <h2>🔒 未登录</h2>
                        <p>点击下方按钮开始 OIDC 登录流程。</p>
                        <button onclick="login()">登录</button>
                    </div>
                `;
            }
        }

        // 登录函数
        function login() {
            // 清除可能存在的旧状态
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('code_verifier'); // PKCE
            
            // 生成 state 和 code_verifier (用于安全)
            const state = generateRandomString(40);
            const codeVerifier = generateRandomString(128);
            
            // 存储到 localStorage，以便在回调时验证
            localStorage.setItem('state', state);
            localStorage.setItem('code_verifier', codeVerifier);

            // 构建 OIDC 授权 URL
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: idpConfig.client_id,
                redirect_uri: idpConfig.redirect_uri,
                scope: idpConfig.scope,
                state: state,
                // code_challenge: CODE_CHALLENGE, // 如果 IDP 支持 PKCE，需要计算 code_challenge
                // code_challenge_method: 'S256'
            });

            const authUrl = `${idpConfig.authorization_endpoint}?${params.toString()}`;
            console.log('Redirecting to:', authUrl);
            window.location.href = authUrl;
        }

        // 处理 IDP 回调
        async function handleCallback() {
            const params = parseQueryString(window.location.search);
            const code = params.code;
            const state = params.state;
            const storedState = localStorage.getItem('state');
            const error = params.error;

            if (error) {
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>❌ 登录失败</h2><p>错误: ${error}</p><p>描述: ${params.error_description}</p></div>`;
                return;
            }

            if (!code || !state) {
                // 如果没有 code 和 state，说明是首次访问，不是回调
                renderStatus();
                return;
            }

            if (state !== storedState) {
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>❌ 安全错误</h2><p>State 不匹配，可能存在 CSRF 攻击。</p></div>`;
                return;
            }

            // 用授权码换取令牌
            try {
                const tokenResponse = await fetch(idpConfig.token_endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: idpConfig.redirect_uri,
                        client_id: idpConfig.client_id,
                        // client_secret: 'your-client-secret', // 如果是 confidential client
                        // code_verifier: localStorage.getItem('code_verifier') // PKCE
                    })
                });

                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    throw new Error(`Token request failed: ${tokenResponse.status} ${errorText}`);
                }

                const tokens = await tokenResponse.json();
                
                // 存储令牌
                localStorage.setItem('id_token', tokens.id_token);
                localStorage.setItem('access_token', tokens.access_token);
                if (tokens.refresh_token) {
                    localStorage.setItem('refresh_token', tokens.refresh_token);
                }

                // (可选) 使用 access_token 获取用户信息
                if (idpConfig.userinfo_endpoint && tokens.access_token) {
                    try {
                        const userResponse = await fetch(idpConfig.userinfo_endpoint, {
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`
                            }
                        });
                        if (userResponse.ok) {
                            const userInfo = await userResponse.json();
                            localStorage.setItem('user_info', JSON.stringify(userInfo));
                        }
                    } catch (e) {
                        console.error('Failed to fetch user info:', e);
                    }
                }

                // 清理 URL 中的查询参数
                window.history.replaceState({}, document.title, window.location.pathname);

                // 重新渲染页面
                renderStatus();

            } catch (error) {
                console.error('Error exchanging code for token:', error);
                document.getElementById('status-container').innerHTML = `<div class="status logged-out"><h2>❌ 令牌交换失败</h2><p>${error.message}</p></div>`;
            } finally {
                // 清理临时存储的 state 和 code_verifier
                localStorage.removeItem('state');
                localStorage.removeItem('code_verifier');
            }
        }

        // 登出函数
        function logout() {
            // 清除本地存储
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');

            // 如果 IDP 提供了登出端点，则跳转过去
            if (idpConfig.end_session_endpoint) {
                // 有些 IDP 需要传递 post_logout_redirect_uri
                const logoutUrl = `${idpConfig.end_session_endpoint}?post_logout_redirect_uri=${encodeURIComponent(idpConfig.redirect_uri)}`;
                window.location.href = logoutUrl;
            } else {
                // 否则，仅刷新本地页面状态
                renderStatus();
            }
        }

        // 页面加载时执行
        window.onload = function() {
            handleCallback();
        };
    </script>

</body>
</html>
